<!doctype html>
<!--
/***************************************************************************
 *
 * Copyright (c) 2012 Baidu.com, Inc. All Rights Reserved
 * $Id: widget.test.html 11341 2012-08-28 03:37:49Z liyubei $
 *
 **************************************************************************/



/**
 * src/ad/widget/widget_test.html ~ 2012/05/10 10:49:04
 * @author liyubei@baidu.com (liyubei)
 * @version $Revision: 11341 $ 
 * @description
 *
 **/
-->
<html>
<head>
    <meta charset="utf-8" />
    <title>[TEST]ad.widget.Widget</title>
    <script type="text/javascript" src="../../../assets/js/tangram-base-1.3.7.1.js"></script>
    <script type="text/javascript" src="../../../assets/js/mustache.js"></script>
    <script type="text/javascript" src="../../base.js"></script>
    <script type="text/javascript">
        goog.require('ad.Debug');
        goog.require('ad.widget.Widget');
        goog.require('third_party.qunit.Qunit');
    </script>
</head>
<body>
  <div id="qunit"></div>
  <div id="root"></div>
</body>
<script type="text/javascript">
function MyWidget(data) {
    ad.widget.Widget.call(this, data);
    this._view = 'AD_my_widget';
    this._patchDataCallCount = 0;
}
baidu.inherits(MyWidget, ad.widget.Widget);
MyWidget.prototype.patchData = function() {
    this._patchDataCallCount += 1;
}

er.template.parse([
    '<!-- target:AD_my_widget -->',
    '<div class="ad-widget ad-my-widget">',
        '<span id="{{#_id}}hello{{/_id}}"><a title2="NEW">{{{name}}}</a></span>',
    '</div>'
].join('\n'));

var widget = new MyWidget({'name' : 'HELLO WORLD'});
widget.setRoot(baidu.g("root").appendChild(document.createElement('DIV')));
widget.render();

function bootstrap() {
  test('getId', function(){
    ok(null != baidu.g(widget.getId('hello')), 'getId should not be null');
    equal(widget.getId('hello'), widget._id + '-hello');
    ok(null != widget.getData());
    ok(null != widget.getData()['_id']);
  });

  test('sendLog1', function(){
    var t1, t2;

    // Widget内部实现的方式
    function internal_log_handler(title, xp) {
      t1 = title;
    }
    widget.addListener(ui.events.SEND_LOG, internal_log_handler);

    // 可能在Material里面添加的处理函数
    function custom_log_hander(title, xp) {
      t2 = title;
    }
    widget.addListener(ui.events.SEND_LOG, custom_log_hander);


    // 触发日志的发送事件
    widget.sendLog("HELLO", "WORLD");

    equal(t1, "HELLO");
    equal(t2, "HELLO");

    widget.removeListener(ui.events.SEND_LOG, internal_log_handler);
    widget.removeListener(ui.events.SEND_LOG, custom_log_hander);
  });

  test('sendLog2', function(){
    var t1, t2;

    // Widget内部实现的方式
    function internal_log_handler(title, xp) {
      t1 = title;
    }
    widget.addListener(ui.events.SEND_LOG, internal_log_handler);

    // 可能在Material里面添加的处理函数
    function custom_log_hander(title, xp) {
      t2 = title;
      return false;
    }
    widget.addListener(ui.events.SEND_LOG, custom_log_hander);


    // EventDispatcher的事件模型存在问题
    // 少了EventTarget和Event这两个元素

    widget.sendLog("HELLO", "WORLD");

    equal(t2, "HELLO");
    equal(t1, undefined);

    widget.removeListener(ui.events.SEND_LOG, internal_log_handler);
    widget.removeListener(ui.events.SEND_LOG, custom_log_hander);
  });

  test("rewriteTitle2", function(){
    var link = baidu.g(widget.getId('hello')).firstChild;

    widget.rewriteTitle2(widget.getRoot(), "GOOG");
    equal('GOOG-NEW', link.getAttribute('title2'));
    widget.rewriteTitle2(widget.getRoot(), "GOOG");
    equal('GOOG-GOOG-NEW', link.getAttribute('title2'));
    widget.rewriteTitle2(widget.getRoot(), "GOOG");
    equal('GOOG-GOOG-GOOG-NEW', link.getAttribute('title2'));
  });

  test("refresh", function(){
    widget.refresh(null, {"name" : "你好，世界"});

    var link = baidu.g(widget.getId('hello')).firstChild;
    equal(link.innerHTML, "你好，世界");
    equal(widget._patchDataCallCount, 1);
  });
}

ad.Debug(bootstrap);
</script>
</html>
