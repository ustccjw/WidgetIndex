<!-- target:AD_ad_config_editor -->
{{{xml_head}}}
<Module>
    <ModulePrefs title="" width="540" height="300" description="" screenshot="IGNORE" thumbnail="IGNORE"></ModulePrefs>
    {{{user_prefs}}}

    <Content type="html"><![CDATA[
        <div id="canvas" class="canvas"></div>
        <script type="text/javascript">
            /******************************* basic function *************************************/
            var rcv_map = {};
            /**
             * 从物料代码中寻找rcv链接并保存
             */
            function cacheRCV() {
                var links = baidu.g(ID('canvas')).getElementsByTagName('a');
                baidu.each(links, function(ele) {
                    var stlocation = baidu.dom.getAttr(ele, 'stlocation');
                    if (stlocation) {
                        var stclass = baidu.dom.getAttr(ele, 'stclass'),
                            sttext = baidu.dom.getAttr(ele, 'sttext'),
                            inner = ele.innerHTML,
                            linkid = baidu.dom.getAttr(related_link, 'linkid'),
                            href = ele.href;
                        rcv_map[stlocation + (stclass || '') + (sttext || inner || '')] = {
                            'linkid': (linkid || ''),
                            'href': (href || '')
                        };
                    }
                });
            }

            /**
             * 将rcv链接重新设置到链接中去(渲染逻辑放到registerOnLoadHandler里之后，物料投放时会将之前的链接清除掉，需要恢复其中的rcv信息，即linkid和rcv链接地址)
             */
            function recoverRCV() {
                var links = baidu.g(ID('canvas')).getElementsByTagName('a'),
                    is_map_exist = baidu.object.keys(rcv_map).length > 0;
                if (!is_map_exist) {
                    return false;
                }
                baidu.each(links, function(ele) {
                    var stlocation = baidu.dom.getAttr(ele, 'stlocation');
                    if (stlocation) {
                        var stclass = baidu.dom.getAttr(ele, 'stclass'),
                            sttext = baidu.dom.getAttr(ele, 'sttext'),
                            inner = ele.innerHTML,
                            key = stlocation + (stclass || '') + (sttext || inner || ''),
                            rcv_obj = rcv_map[key];
                        if (rcv_obj) {
                            rcv_obj['linkid'] && baidu.dom.setAttr(ele, 'linkid', rcv_obj['linkid']);
                            rcv_obj['href'] && (ele.href = rcv_obj['href']);
                        } else {
                            try {
                                console.log(key + '\'s rcv not exist');
                            } catch(e) {}
                        }
                    }
                });
            }
            baidu.gadgets.render = function() {
                var prefs = baidu.gadgets.getPrefs();
            };

            baidu.gadgets.registerOnLoadHandler(function(){
                var prefs = baidu.gadgets.getPrefs();
                // 记录rcv链接
                cacheRCV();

                // material code here
                {{{material_code}}}

                // 还原rcv链接
                recoverRCV();
            });
            {{{script_end_tag}}}
    ]]>
    </Content>
</Module>

