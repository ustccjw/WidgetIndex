<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" >
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=gbk">
<style>
a{color:#261CDC}
.btn_st{
		font-size:13px;height:24px;
		line-height:24px;
		_line-height:20px;
	}
</style>
<script src="http://static.tieba.baidu.com/tb/nocache/post_video_url.js" type="text/javascript"></script>
<script type="text/javascript">

try{document.execCommand("BackgroundImageCache",false,true);}catch(e) {}

String.prototype.trim=function(){return this.replace(/(^[\s\t\xa0\u3000]+)|([\u3000\xa0\s\t]+$)/g, "")};
String.prototype.getByteLength=function(){return this.replace(/[^\x00-\xff]/g, "mm").length;};

var editorID = getSearchById('id');

function getSearchById (id) {
	var s = location.search,
		r = new RegExp('.*'+id+'=([^&]*).*', 'i');
	return s.replace(r, '$1');
}

var editor = parent.TED.Editor.getInstanceById(editorID);

TiFlash = {
    IE : (!!(window.attachEvent && !window.opera)),
	validAddrPrefixs : [
		"http://img.ku6.com/common/V2.0.baidu.swf?vid=",

		"http://www.tudou.com/v/",
		"http://www.tudou.com/player/playlist.swf?lid=",
		"http://www.56.com/",
		"http://player.youku.com/",
		"http://6.cn/",

		"http://player.ku6.com/refer/",
		"http://tv.mofile.com/cn/xplayer.swf?v=",
		"http://v.blog.sohu.com/fo/v4/",
		"http://v.blog.sohu.com/fo/p4/",
		"http://vhead.blog.sina.com.cn/player/outer_player.swf?",

		"http://img.openv.tv/hd/swf/hd_player.swf?pid=",
		"http://www.cnboo.com/flash/player.swf?ids=",
		"http://video.pomoho.com/swf/out_player.swf?flvid=",

		"http://video.cctv.com/flash/cctv_player.swf?VideoID=",
		"http://misc.home.news.cn/video/swf/VideoDisplay.swf?videoSource=",
		"http://mv.baidu.com/export/flashplayer.swf?playlist=",
		"http://mv.baidu.com/export/flashplayer.swf?vid=",
		"http://client.joy.cn/flvplayer/"
	],
    accept: function (){
        try{
            
        if(editor.config.flashWhiteList){
            var whiteList= editor.config.flashWhiteList;
        }else{
            var whiteList = this.validAddrPrefixs;
        }

		var isInWhiteList = function(url){
			for(var i = 0, j = whiteList.length; i < j; i ++){
                if(url.indexOf(whiteList[i]) == 0) return true;
			}
			return false;
		}

		var flash_url_value = document.getElementById('bde_flash_url').value.trim().replace(/^http:\/\/http:\/\//g, "http://");
		flash_url_value = this.convertUrl(flash_url_value);
      

		var urlexp = /^(https:\/\/|http:\/\/|ftp:\/\/|rtsp:\/\/|mms:\/\/)/;
		if(!(urlexp.test(flash_url_value.toLowerCase()))){
			flash_url_value = "http://" + flash_url_value;
		}
		var lower_url = flash_url_value.toLowerCase();

		if(lower_url.length <= 0 
			|| lower_url == "https://" 
			|| lower_url == "http://" 
			|| lower_url == "ftp://"
			|| lower_url == "rtsp://"
			|| lower_url == "mms://"){

			this.showError("视频链接不能为空");
			return false;
		}
        urlexp = /(\.html|\.htm|\.shtml|\.xml|\.jpg|\.jpeg|\.bmp|\.png|\.gif|\.tif)$/;
		if(flash_url_value.getByteLength() > editor.urlLength || urlexp.test(lower_url)){
			this.showError("输入链接有误，请重试");
			return false;
		}
		if(!isInWhiteList(flash_url_value)){
			this.showError("对不起，您输入的视频链接无效，请重试");
			return false;
		}
		flash_url_value = Post_Video_URL.convert(flash_url_value);
        flash_url_value = Post_Video_URL.filter_param(flash_url_value);
		editor.execCommand('insertflash', flash_url_value);
		// 识别成功后的统计
    parent.Stats.sendRequest('fr=tb0_forum&st_mod=editor&st_type=videoByLayer&st_value=1'); 
    editor.overlay.close();  
        }catch(e){}
        
        return false;
	},
	convertUrl : function(url){
				var htmlReg=/(?:http:\/\/((?:[a-zA-Z\d\-]+\.)+[a-zA-Z\d]+(?:\:[\d]{2,5})?)\/([^\s]+?)\.(html)|(?:http:\/\/(www\.tudou\.com)\/(programs\/view\/[^\s]+?)\/))/gi;
				var result = htmlReg.exec(url);
				if(result!==null){
					 if(result[4]&&result[5]){
					 		url= this.classifyUrl(result[0],result[4],result[5]);
					 	}else{
					 		url = this.classifyUrl(result[0],result[1],result[2],result[3]);			
					 	}
				}
				return url;
	},
	classifyUrl:function(s,s_domain,s_name,s_extension){
				var domain_reg = /(v\.youku\.com)|(www\.tudou\.com)|(v\.ku6\.com)|(www\.56\.com)/gi;
				var result = domain_reg.exec(s_domain);
				if(result==null)
						return s;
				var url = "";
			  var name_id = s_name.split("/");
			  var video_name = name_id[name_id.length-1];
			  var fail = false;
			  
				switch(result[0])
				{
					case "v.youku.com" :
							if(name_id[0]=="v_show")
							{
						    var name_sp = video_name.split("_");
						    if(name_sp[1])
								url = 'http://player.youku.com/player.php/sid/'+name_sp[1]+'/v.swf';
								else
								{
									fail = true;
									url = s;
								}
							}else
								{
									fail = true;
								  url = s;
								}
							break;				
					case "www.tudou.com":
							if(name_id[0]=="programs"&&name_id[1]=="view")
							url = 'http://www.tudou.com/v/'+video_name+'/v.swf';
							else
							{
									fail = true;
								  url = s;
							}
							break;
					case "v.ku6.com":
							if(name_id[0]=="show"||name_id[0]=="special")
								url = 'http://player.ku6.com/refer/'+video_name+'/v.swf';
							else
							{
									fail = true;
								  url = s;
								}
							break;
					case "www.56.com":
							var first = name_id[0];
							if(first.search(/^[uw][^\s]+/g)!=-1)
								url = 'http://player.56.com/'+video_name+'.swf';
							else
							{
									fail = true;
								  url = s;
								}
							break;
					default:
					   	url = s;
					   	break;
				}
				if(fail)
				 		parent.Stats.sendRequest('fr=tb0_forum&st_mod=editor&st_type=urlVideoRecFail&st_value=1'); 
				return url;
		},
	onFocusInput : function(){
		document.getElementById('bde_flash_tip').innerHTML = "贴吧目前支持土豆、优酷、激动等多家视频网站";
		document.getElementById('bde_flash_tip').style.color = "#666666";
	},
	showError : function(msg){
		document.getElementById('bde_flash_tip').innerHTML = msg;
		document.getElementById('bde_flash_tip').style.color = "#ff0000";
	}
};


window.onload = function(){
	var input = document.getElementById('bde_flash_url');
    input.focus();
    try{
	    if(TiFlash.IE){
			input.select();
		}else{
			input.setSelectionRange(0, input.value.length);
		}
	}catch(e){}
};

</script>
</head>
<body style="margin:0;">
<form action="/f" onSubmit="TiFlash.accept();return false"><table cellpadding="2" cellspacing="0" border="0" width="100%" style="margin: 25px 12px 10px 12px;font-size:12px">
<tr><td width="70px">视频链接：</td><td width="330px"><input type="text" name="bde_flash_url" id="bde_flash_url" value="http://" style="width:325px" oncontextmenu="this.select()" onClick="this.select()" onFocus="TiFlash.onFocusInput()"></td><td>（<a href="http://tieba.baidu.com/tb/help/new/index.html#n5" target="_blank">如何贴视频？</a>）</td></tr>
<tr><td>&nbsp;</td><td><div id="bde_flash_tip" style="font-size:12px;color:#484540;line-height:25px;">贴吧目前支持土豆、优酷、激动等多家视频网站</div></td></tr>
<tr><td>&nbsp;</td><td><input type="submit" name="insertAccept" class="btn_st" id="insertAccept" value="插入视频"></td></tr>
<tr><td>&nbsp;</td><td colspan="2" style="color:#a0998e;height:32px;font-size:12px">注意：一层楼最多可插入<script>document.write(editor.config.flashNumLimit);</script>个视频，想插入更多视频？加入本吧会员即可！</td></tr>
</table></form>
</body>
</html><!--24287191341411928330052615-->